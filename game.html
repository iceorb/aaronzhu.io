<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Evolution — Aaron Zhu</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Source+Serif+4:ital,opsz,wght@0,8..60,300..900;1,8..60,300..900&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="styles.css">
    <style>
        /* Game-specific overrides */
        .game-container {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }

        .game-sidebar {
            width: 280px;
            flex-shrink: 0;
            background: var(--hud-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid var(--line);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 10;
            overflow-y: auto;
            padding-top: 1.5rem;
        }

        .game-sidebar h1 {
            font-size: 1.5rem;
            margin-bottom: 0;
            line-height: 1.2;
        }

        .game-sidebar p {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--secondary);
            margin-bottom: 0;
        }

        .game-sidebar hr {
            border: none;
            border-top: 1px solid var(--line);
        }

        .game-main {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        #simCanvas {
            image-rendering: pixelated;
            cursor: crosshair;
        }

        /* Controls */
        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            background: var(--hud-bg);
            border: 1px solid var(--line);
            color: var(--text-color);
            padding: 0.5rem 1rem;
            border-radius: var(--hud-radius);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--font-main);
        }

        .btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-full {
            width: 100%;
        }

        /* Sliders */
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .slider-value {
            font-family: var(--font-mono);
            color: var(--accent);
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--accent);
            height: 4px;
            background: var(--line);
            border-radius: 2px;
            cursor: pointer;
        }

        .slider-desc {
            font-size: 0.65rem;
            color: var(--tertiary);
        }

        /* Stats bars */
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            font-size: 0.8rem;
        }

        .stat-label {
            color: var(--secondary);
        }

        .stat-value {
            font-weight: 600;
        }

        .stat-value.cooperator {
            color: #34d399;
        }

        .stat-value.defector {
            color: var(--accent);
        }

        .bar-track {
            width: 100%;
            height: 4px;
            background: var(--line);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .bar-fill.cooperator {
            background: #34d399;
        }

        .bar-fill.defector {
            background: var(--accent);
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            background: var(--hud-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--line);
            padding: 1rem 1.5rem;
            border-radius: var(--hud-radius);
            display: flex;
            gap: 2rem;
            font-size: 0.75rem;
            pointer-events: none;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.cooperator {
            background: #34d399;
            box-shadow: 0 0 8px rgba(52, 211, 153, 0.6);
        }

        .legend-dot.defector {
            background: var(--accent);
            box-shadow: 0 0 8px rgba(235, 59, 59, 0.6);
        }

        .legend-dot.switched {
            background: #f59e0b;
        }

        .info-text {
            font-size: 0.65rem;
            color: var(--tertiary);
            text-align: center;
            line-height: 1.5;
        }

        /* Explainer sections */
        .explainer {
            background: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }

        @media (prefers-color-scheme: dark) {
            .explainer {
                background: rgba(255, 255, 255, 0.03);
            }
        }

        .explainer-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-color);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .explainer-title svg {
            opacity: 0.6;
        }

        .explainer-content {
            font-size: 0.8rem;
            line-height: 1.6;
            color: var(--secondary);
            text-transform: none;
            letter-spacing: normal;
        }

        .explainer-content strong {
            color: var(--text-color);
            font-weight: 500;
        }

        .explainer-content ul {
            margin: 0.5rem 0 0 0;
            padding-left: 1.2rem;
        }

        .explainer-content li {
            margin-bottom: 0.4rem;
        }

        .coop-color {
            color: #34d399;
            font-weight: 500;
        }

        .defect-color {
            color: var(--accent);
            font-weight: 500;
        }

        [data-theme="1995"] .explainer {
            background: #fff;
            border: 1px solid #808080;
            border-radius: 0;
        }

        [data-theme="terminal"] .explainer {
            background: rgba(51, 255, 0, 0.05);
            border: 1px dashed var(--line);
            border-radius: 0;
        }

        [data-theme="terminal"] .coop-color {
            color: var(--text-color);
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .modal {
            background: var(--bg-color);
            border: 1px solid var(--line);
            border-radius: 16px;
            max-width: 540px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .modal-overlay.hidden .modal {
            transform: translateY(20px);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
            color: var(--text-color);
        }

        .modal-header p {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text-color);
        }

        .modal .explainer {
            margin-bottom: 1rem;
        }

        .modal .explainer:last-child {
            margin-bottom: 0;
        }

        .modal-footer {
            margin-top: 1.5rem;
            text-align: center;
        }

        .btn-start {
            background: var(--accent);
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: var(--hud-radius);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--font-main);
        }

        .btn-start:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Info button in sidebar */
        .info-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid var(--line);
            color: var(--secondary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--font-main);
        }

        .info-btn:hover {
            background: rgba(0, 0, 0, 0.06);
            color: var(--text-color);
            border-color: var(--text-color);
        }

        @media (prefers-color-scheme: dark) {
            .info-btn {
                background: rgba(255, 255, 255, 0.03);
            }

            .info-btn:hover {
                background: rgba(255, 255, 255, 0.06);
            }
        }

        [data-theme="1995"] .modal {
            border-radius: 0;
            border: 2px outset #fff;
            background: #c0c0c0;
        }

        [data-theme="1995"] .btn-start {
            border-radius: 0;
            border: 2px solid;
            border-color: #fff #808080 #808080 #fff;
        }

        [data-theme="1995"] .info-btn {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #fff #808080 #808080 #fff;
            border-radius: 0;
        }

        [data-theme="terminal"] .modal {
            border-radius: 0;
            border: 1px solid var(--text-color);
        }

        [data-theme="terminal"] .btn-start {
            border-radius: 0;
            border: 1px solid var(--text-color);
            background: transparent;
            color: var(--text-color);
        }

        [data-theme="terminal"] .info-btn {
            border-radius: 0;
            border: 1px solid var(--text-color);
        }

        /* Theme overrides for game */
        [data-theme="1995"] .game-sidebar {
            background: #c0c0c0;
            backdrop-filter: none;
            border-right: 2px outset #fff;
        }

        [data-theme="1995"] .btn {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #fff #808080 #808080 #fff;
            border-radius: 0;
        }

        [data-theme="1995"] .btn:hover {
            background: #000080;
            color: white;
        }

        [data-theme="1995"] .legend {
            background: #c0c0c0;
            backdrop-filter: none;
            border: 2px outset #fff;
            border-radius: 0;
        }

        [data-theme="terminal"] .game-sidebar {
            background: rgba(0, 0, 0, 0.9);
            border-right: 1px solid var(--text-color);
        }

        [data-theme="terminal"] .btn {
            border-radius: 0;
            border: 1px solid var(--text-color);
        }

        [data-theme="terminal"] .legend {
            border-radius: 0;
            border: 1px solid var(--text-color);
        }

        [data-theme="terminal"] .stat-value.cooperator,
        [data-theme="terminal"] .legend-dot.cooperator {
            color: var(--text-color);
            background: var(--text-color);
        }

        [data-theme="terminal"] .bar-fill.cooperator {
            background: var(--text-color);
        }

        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
            }

            .game-sidebar {
                width: 100%;
                padding: 1rem;
            }

            .game-main {
                min-height: 60vh;
            }
        }
    </style>
</head>

<body>

    <!-- Info Modal -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h2 class="serif">Agent Evolution</h2>
                    <p>Evolutionary Game Theory Simulation</p>
                </div>
                <button id="modalClose" class="modal-close">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="explainer">
                <div class="explainer-title">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M12 16v-4M12 8h.01" />
                    </svg>
                    What's Happening
                </div>
                <div class="explainer-content">
                    Each pixel is an <strong>agent</strong> playing a game with its neighbors.
                    <span class="coop-color">Green agents cooperate</span>.
                    <span class="defect-color">Red agents defect</span>.
                    <br><br>
                    Every round, agents look at their neighbors and <strong>copy the strategy</strong> of whoever scored
                    highest. It's evolution by imitation.
                </div>
            </div>

            <div class="explainer">
                <div class="explainer-title">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                    The Prisoner's Dilemma
                </div>
                <div class="explainer-content">
                    When two agents interact:
                    <ul>
                        <li><strong>Both cooperate</strong> → both get the <em>Reward</em></li>
                        <li><strong>Both defect</strong> → both get <em>Punishment</em> (almost nothing)</li>
                        <li><strong>One defects, one cooperates</strong> → defector gets the <em>Temptation</em> bonus,
                            cooperator gets nothing</li>
                    </ul>
                    The dilemma: defecting is better for the individual, but cooperation is better for everyone.
                </div>
            </div>

            <div class="explainer">
                <div class="explainer-title">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 3v18M3 12h18" />
                    </svg>
                    Try This
                </div>
                <div class="explainer-content">
                    <ul>
                        <li><strong>Click the canvas</strong> to inject defectors</li>
                        <li><strong>Raise Temptation (T)</strong> → watch defectors spread like a virus</li>
                        <li><strong>Lower Temptation to ~1.8</strong> → watch fractal patterns emerge</li>
                        <li><strong>Set T = R = 1.0</strong> → cooperation and defection become stable</li>
                    </ul>
                </div>
            </div>

            <div class="modal-footer">
                <button id="modalStart" class="btn-start">Start Simulation</button>
                <p style="margin-top: 1rem; font-size: 0.75rem;">
                    <a href="https://en.wikipedia.org/wiki/Evolutionary_game_theory" target="_blank" rel="noopener"
                        style="color: var(--secondary); text-decoration: underline;">
                        Learn more on Wikipedia →
                    </a>
                </p>
            </div>
        </div>
    </div>

    <div class="noise"></div>
    <div class="orb" id="orb"></div>
    <div class="cursor-circle" id="c-circle"></div>

    <div class="game-container">

        <!-- Sidebar Controls -->
        <aside class="game-sidebar">
            <!-- Compact header with back and theme -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <a href="index.html" class="btn"
                    style="padding: 0.4rem 0.75rem; font-size: 0.75rem; display: flex; align-items: center; gap: 0.3rem;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                    Back
                </a>
                <button id="theme-btn" class="btn" style="padding: 0.4rem 0.75rem; font-size: 0.7rem;">MODE</button>
            </div>

            <div>
                <h1 class="serif">Agent Evolution</h1>
                <p>Evolutionary Game Theory</p>
            </div>

            <!-- Info Button -->
            <button id="infoBtn" class="info-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M12 16v-4M12 8h.01" />
                </svg>
                How It Works
            </button>

            <div class="space-y-4">
                <div class="control-row">
                    <span style="font-size: 0.85rem; font-weight: 500;">Simulation</span>
                    <button id="playPauseBtn" class="btn btn-primary">Pause</button>
                </div>

                <button id="resetBtn" class="btn btn-full" style="margin-top: 1rem;">Reset Population</button>

                <div class="slider-group" style="margin-top: 1rem;">
                    <div class="slider-header">
                        <span>Speed</span>
                        <span id="valSpeed" class="slider-value">Slow</span>
                    </div>
                    <input type="range" id="inputSpeed" min="1" max="5" step="1" value="2">
                    <span class="slider-desc">How fast generations evolve</span>
                </div>
            </div>

            <hr>

            <!-- Payoff Matrix Section -->
            <div>
                <h3
                    style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--secondary); margin-bottom: 1rem;">
                    Payoff Matrix
                </h3>
                <p style="font-size: 0.7rem; font-style: italic; margin-bottom: 1rem;">Adjust rewards for the Prisoner's
                    Dilemma:</p>

                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div class="slider-group">
                        <div class="slider-header">
                            <span>Temptation (T)</span>
                            <span id="valT" class="slider-value">1.9</span>
                        </div>
                        <input type="range" id="inputT" min="1.0" max="2.5" step="0.01" value="1.9">
                        <span class="slider-desc">Defect while other Cooperates</span>
                    </div>

                    <div class="slider-group">
                        <div class="slider-header">
                            <span>Reward (R)</span>
                            <span id="valR" class="slider-value">1.0</span>
                        </div>
                        <input type="range" id="inputR" min="0.0" max="2.0" step="0.1" value="1.0">
                        <span class="slider-desc">Both Cooperate</span>
                    </div>

                    <div class="slider-group">
                        <div class="slider-header">
                            <span>Punishment (P)</span>
                            <span id="valP" class="slider-value">0.1</span>
                        </div>
                        <input type="range" id="inputP" min="0.0" max="1.0" step="0.1" value="0.1">
                        <span class="slider-desc">Both Defect</span>
                    </div>
                </div>
            </div>

            <hr>

            <!-- Stats -->
            <div style="margin-top: auto;">
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div>
                        <div class="stat-row">
                            <span class="stat-label">Cooperators</span>
                            <span id="countC" class="stat-value cooperator">0%</span>
                        </div>
                        <div class="bar-track">
                            <div id="barC" class="bar-fill cooperator" style="width: 50%"></div>
                        </div>
                    </div>

                    <div>
                        <div class="stat-row">
                            <span class="stat-label">Defectors</span>
                            <span id="countD" class="stat-value defector">0%</span>
                        </div>
                        <div class="bar-track">
                            <div id="barD" class="bar-fill defector" style="width: 50%"></div>
                        </div>
                    </div>
                </div>

                <p class="info-text" style="margin-top: 1.5rem;">
                    Agents copy the strategy of their most successful neighbor.
                </p>
            </div>
        </aside>

        <!-- Main Viewport -->
        <main class="game-main">
            <canvas id="simCanvas"></canvas>

            <!-- Legend Overlay -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot cooperator"></div>
                    <span>Cooperator</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot defector"></div>
                    <span>Defector</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot switched"></div>
                    <span>High Payoff</span>
                </div>
            </div>
        </main>
    </div>

    <script src="common.js"></script>
    <script>
        /**
         * EVOLUTIONARY GAME THEORY SIMULATION
         * Based on Nowak & May (1992)
         */

        // Modal Controls
        const infoModal = document.getElementById('infoModal');
        const modalClose = document.getElementById('modalClose');
        const modalStart = document.getElementById('modalStart');
        const infoBtn = document.getElementById('infoBtn');

        const closeModal = () => {
            infoModal.classList.add('hidden');
        };

        const openModal = () => {
            infoModal.classList.remove('hidden');
        };

        modalClose.onclick = closeModal;
        modalStart.onclick = closeModal;
        infoBtn.onclick = openModal;

        // Close modal on overlay click (but not modal content)
        infoModal.onclick = (e) => {
            if (e.target === infoModal) closeModal();
        };

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !infoModal.classList.contains('hidden')) {
                closeModal();
            }
        });

        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const resetBtn = document.getElementById('resetBtn');

        // Configurable Parameters
        const cellSize = 8;
        let cols, rows;
        let grid = [];
        let nextGrid = [];
        let scores = [];
        let isRunning = true;

        // Payoff Values
        let payoffT = 1.9; // Temptation (D against C)
        let payoffR = 1.0; // Reward (C against C)
        let payoffP = 0.1; // Punishment (D against D)
        let payoffS = 0.0; // Sucker (C against D)

        // Get computed styles for theming
        const getAccentColor = () => getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#eb3b3b';
        const getCooperatorColor = () => {
            const theme = document.documentElement.getAttribute('data-theme');
            if (theme === 'terminal') return getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
            return '#34d399';
        };

        // UI Binding
        const inputs = {
            T: document.getElementById('inputT'),
            R: document.getElementById('inputR'),
            P: document.getElementById('inputP')
        };
        const vals = {
            T: document.getElementById('valT'),
            R: document.getElementById('valR'),
            P: document.getElementById('valP')
        };

        function updateParams() {
            payoffT = parseFloat(inputs.T.value);
            payoffR = parseFloat(inputs.R.value);
            payoffP = parseFloat(inputs.P.value);
            vals.T.innerText = payoffT.toFixed(2);
            vals.R.innerText = payoffR.toFixed(1);
            vals.P.innerText = payoffP.toFixed(1);
        }

        Object.values(inputs).forEach(input => input.addEventListener('input', updateParams));

        // Initialization
        function init() {
            const parent = canvas.parentElement;
            const w = parent.clientWidth;
            const h = parent.clientHeight;
            canvas.width = Math.floor(w / cellSize) * cellSize;
            canvas.height = Math.floor(h / cellSize) * cellSize;

            cols = canvas.width / cellSize;
            rows = canvas.height / cellSize;

            grid = new Int8Array(cols * rows);
            nextGrid = new Int8Array(cols * rows);
            scores = new Float32Array(cols * rows);

            for (let i = 0; i < grid.length; i++) {
                // Initialize mostly Cooperators (1), few Defectors (0)
                grid[i] = Math.random() > 0.05 ? 1 : 0;
            }
        }

        function getIdx(x, y) {
            // Toroidal (wrapping) coordinates
            const tx = (x + cols) % cols;
            const ty = (y + rows) % rows;
            return ty * cols + tx;
        }

        function calculateScores() {
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    let totalScore = 0;
                    const myStrategy = grid[getIdx(x, y)];

                    // Play against 8 neighbors + self
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            const neighborStrategy = grid[getIdx(x + dx, y + dy)];

                            // Payoff Matrix
                            if (myStrategy === 1 && neighborStrategy === 1) totalScore += payoffR;
                            else if (myStrategy === 0 && neighborStrategy === 1) totalScore += payoffT;
                            else if (myStrategy === 1 && neighborStrategy === 0) totalScore += payoffS;
                            else if (myStrategy === 0 && neighborStrategy === 0) totalScore += payoffP;
                        }
                    }
                    scores[getIdx(x, y)] = totalScore;
                }
            }
        }

        function evolve() {
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    let bestScore = -1;
                    let bestStrategy = grid[getIdx(x, y)];

                    // Look at neighbors and copy the strategy of the highest scorer
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            const idx = getIdx(x + dx, y + dy);
                            if (scores[idx] > bestScore) {
                                bestScore = scores[idx];
                                bestStrategy = grid[idx];
                            }
                        }
                    }
                    nextGrid[getIdx(x, y)] = bestStrategy;
                }
            }
            grid.set(nextGrid);
        }

        function draw() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            let cCount = 0;
            const cooperatorColor = getCooperatorColor();
            const defectorColor = getAccentColor();

            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const idx = getIdx(x, y);
                    const strategy = grid[idx];

                    if (strategy === 1) {
                        ctx.fillStyle = cooperatorColor;
                        cCount++;
                    } else {
                        // Color defectors based on their recent history for visual depth
                        const s = scores[idx];
                        if (s > payoffT * 4) ctx.fillStyle = '#f59e0b'; // Amber (High payoff defector)
                        else ctx.fillStyle = defectorColor;
                    }

                    ctx.fillRect(x * cellSize, y * cellSize, cellSize - 1, cellSize - 1);
                }
            }

            // Update UI Stats
            const total = cols * rows;
            const cPercent = (cCount / total) * 100;
            const dPercent = 100 - cPercent;

            document.getElementById('countC').innerText = cPercent.toFixed(1) + '%';
            document.getElementById('countD').innerText = dPercent.toFixed(1) + '%';
            document.getElementById('barC').style.width = cPercent + '%';
            document.getElementById('barD').style.width = dPercent + '%';
        }

        function step() {
            if (isRunning) {
                calculateScores();
                evolve();
                draw();
            }
        }

        // Speed control
        const speedLabels = ['Slowest', 'Slow', 'Medium', 'Fast', 'Fastest'];
        const speedDelays = [500, 200, 80, 30, 0]; // ms between frames
        let currentSpeed = 1; // Default to "Slow" (200ms)
        let stepInterval = null;

        const inputSpeed = document.getElementById('inputSpeed');
        const valSpeed = document.getElementById('valSpeed');

        function updateSpeed() {
            currentSpeed = parseInt(inputSpeed.value) - 1;
            valSpeed.innerText = speedLabels[currentSpeed];

            // Restart the interval with new speed
            if (stepInterval) clearInterval(stepInterval);
            if (speedDelays[currentSpeed] === 0) {
                // Use requestAnimationFrame for max speed
                const fastStep = () => {
                    step();
                    if (speedDelays[currentSpeed] === 0) requestAnimationFrame(fastStep);
                };
                requestAnimationFrame(fastStep);
            } else {
                stepInterval = setInterval(step, speedDelays[currentSpeed]);
            }
        }

        inputSpeed.addEventListener('input', updateSpeed);

        // Interaction
        playPauseBtn.onclick = () => {
            isRunning = !isRunning;
            playPauseBtn.innerText = isRunning ? "Pause" : "Resume";
            playPauseBtn.classList.toggle('btn-primary', isRunning);
        };

        resetBtn.onclick = () => {
            init();
            if (!isRunning) draw();
        };

        canvas.onmousedown = (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const cx = Math.floor(mouseX / cellSize);
            const cy = Math.floor(mouseY / cellSize);

            // Infect an area with defectors on click
            for (let dy = -2; dy <= 2; dy++) {
                for (let dx = -2; dx <= 2; dx++) {
                    grid[getIdx(cx + dx, cy + dy)] = 0;
                }
            }
            draw();
        };

        window.onresize = init;

        // Startup
        init();
        updateParams();
        updateSpeed(); // Start the simulation loop with current speed
    </script>
</body>

</html>